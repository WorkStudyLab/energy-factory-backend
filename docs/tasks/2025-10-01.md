# 태스크 작업 보고서 - CORS 및 배포 문제 해결

**날짜**: 2025-10-01  
**작업자**: Claude Code  
**상태**: ✅ 완료  

## 작업 개요

프론트엔드와 백엔드 간 CORS 에러 해결 작업 중 발견된 배포 및 시스템 문제들을 순차적으로 해결한 작업입니다.

## 수행한 작업 목록

### 1. CORS 설정 추가
- **파일**: `src/main/java/com/energyfactory/energy_factory/config/SecurityConfig.java`
- **작업**: CORS 설정 메서드 추가
- **추가된 Origin**: 
  - S3 프론트엔드 도메인
  - localhost:3000 (개발환경)
  - localhost:5173 (Vite 개발서버)

### 2. 메모리 부족 문제 해결
- **문제**: t2.micro에서 빌드 타임아웃 발생
- **작업**: 
  - EBS 볼륨 8GB → 16GB 확장
  - 파일시스템 확장 (`growpart`, `resize2fs`)
  - Swap 메모리 1GB → 2GB 증설
- **결과**: 총 사용 가능 메모리 3GB 확보

### 3. JWT 설정 누락 해결
- **문제**: `jwt.refresh-token-expiration` 프로퍼티 누락으로 애플리케이션 시작 실패
- **파일**: `src/main/resources/application-dev.yml`
- **추가된 설정**:
  ```yaml
  jwt:
    secret: ${JWT_SECRET_KEY}
    refresh-token-expiration: 604800
  ```

### 4. systemd 환경변수 수정
- **문제**: 환경변수명 불일치 및 DB_URL 줄바꿈 오류
- **파일**: `/etc/systemd/system/energy-factory.service`
- **수정사항**:
  - `DB_USER` → `DB_USERNAME` 변경
  - DB_URL 한 줄로 수정
  - JWT_SECRET_KEY 업데이트

## 발생했던 문제들

### 문제 1: 배포 타임아웃
**증상**: GitHub Actions에서 빌드가 10분 후 타임아웃  
**원인**: EC2 t2.micro 메모리 부족  
**해결**: Swap 메모리 확장으로 해결  

### 문제 2: Spring Boot 시작 실패
**증상**: `Could not resolve placeholder 'jwt.refresh-token-expiration'`  
**원인**: dev 프로파일에 JWT 설정 누락  
**해결**: application-dev.yml에 설정 추가  

### 문제 3: 데이터베이스 연결 실패
**증상**: `Access denied for user '${DB_USERNAME}'`  
**원인**: systemd에서 환경변수가 문자열 그대로 해석됨  
**해결**: systemd 서비스 파일의 환경변수 수정  

### 문제 4: systemd 설정 파일 오류
**증상**: `Unknown key name 'seSSL'`  
**원인**: DB_URL 복사 시 줄바꿈 발생  
**해결**: URL을 한 줄로 수정  

## 커밋 이력

1. `a85f4c5` - feat: CORS 설정 추가 - S3 프론트엔드 도메인 허용
2. `c62a735` - fix: application-dev.yml에 누락된 jwt.refresh-token-expiration 설정 추가

## 최종 결과

### 시스템 상태
- ✅ Spring Boot 애플리케이션 정상 실행
- ✅ 8080 포트 리스닝 확인
- ✅ 데이터베이스 연결 성공
- ✅ API 엔드포인트 응답 정상

### 프론트엔드 연결
- ✅ CORS 에러 해결
- ✅ 프론트엔드에서 백엔드 API 호출 성공

## 소요 시간

- **총 작업 시간**: 약 3시간
- **메모리 확장**: 30분
- **환경변수 디버깅**: 1.5시간
- **CORS 설정**: 30분
- **테스트 및 확인**: 30분

## 사용된 명령어

### 메모리 관리
```bash
sudo growpart /dev/xvda 1
sudo resize2fs /dev/xvda1
sudo dd if=/dev/zero of=/swapfile bs=128M count=16
sudo mkswap /swapfile
sudo swapon /swapfile
```

### 서비스 관리
```bash
sudo systemctl daemon-reload
sudo systemctl restart energy-factory
sudo systemctl status energy-factory
sudo journalctl -u energy-factory -f
```

### 디버깅
```bash
sudo ss -tulpn | grep 8080
tail -f app.log
curl http://localhost:8080/api/products
```

## 학습한 내용

1. **환경변수 일관성**: 코드와 배포 환경의 환경변수명이 정확히 일치해야 함
2. **프리티어 제약**: 메모리 부족 시 Swap 활용이 효과적
3. **설정 파일 관리**: 프로파일별 설정 파일 동기화의 중요성
4. **시스템 디버깅**: systemd 로그와 애플리케이션 로그를 구분해서 확인해야 함

## 다음 작업 예정

- [ ] CI/CD 문서의 환경변수 설정 업데이트
- [ ] 환경변수 검증 스크립트 작성
- [ ] 메모리 모니터링 설정

---

**🤖 Generated with [Claude Code](https://claude.ai/code)**

**Co-Authored-By: Claude <noreply@anthropic.com>**