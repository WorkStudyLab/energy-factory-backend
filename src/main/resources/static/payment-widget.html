<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ ìœ„ì ¯ í…ŒìŠ¤íŠ¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 4px;
        }

        .info-box h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-box p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .test-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .test-info h4 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .test-info ul {
            margin-left: 20px;
            color: #856404;
            font-size: 13px;
        }

        .test-info li {
            margin-bottom: 5px;
        }

        #payment-widget {
            margin: 30px 0;
        }

        #agreement {
            margin: 20px 0;
        }

        .button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .button:active {
            transform: translateY(0);
        }

        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .order-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .order-summary h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #666;
            font-size: 14px;
        }

        .order-total {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #dee2e6;
            font-weight: 600;
            font-size: 18px;
            color: #333;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’³ í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ í…ŒìŠ¤íŠ¸</h1>
        <p class="subtitle">ê²°ì œ ìœ„ì ¯ v2 ì—°ë™ í…ŒìŠ¤íŠ¸ í˜ì´ì§€</p>

        <div class="info-box">
            <h3>ğŸ“Œ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì•ˆë‚´</h3>
            <p>
                í˜„ì¬ í† ìŠ¤í˜ì´ë¨¼ì¸  í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ë™ì‘í•©ë‹ˆë‹¤.<br>
                ì‹¤ì œ ê²°ì œëŠ” ë°œìƒí•˜ì§€ ì•Šìœ¼ë©°, ì „ì²´ ê²°ì œ í”Œë¡œìš°ë¥¼ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
        </div>

        <div class="test-info">
            <h4>ğŸ”‘ í…ŒìŠ¤íŠ¸ ì¹´ë“œ ì •ë³´</h4>
            <ul>
                <li>ì¹´ë“œë²ˆí˜¸: ì•„ë¬´ ìˆ«ì 16ìë¦¬</li>
                <li>ìœ íš¨ê¸°ê°„: ë¯¸ë˜ ë‚ ì§œ (ì˜ˆ: 12/25)</li>
                <li>CVC: ì•„ë¬´ ìˆ«ì 3ìë¦¬</li>
                <li>ë¹„ë°€ë²ˆí˜¸: ì•„ë¬´ ìˆ«ì 2ìë¦¬</li>
            </ul>
        </div>

        <div class="order-summary">
            <h3>ì£¼ë¬¸ ì •ë³´</h3>
            <div class="order-item">
                <span>ìƒí’ˆëª…</span>
                <span id="display-order-name">í…ŒìŠ¤íŠ¸ ìƒí’ˆ</span>
            </div>
            <div class="order-item">
                <span>ì£¼ë¬¸ ID</span>
                <span id="display-order-id">-</span>
            </div>
            <div class="order-total">
                <span>ê²°ì œ ê¸ˆì•¡</span>
                <span id="display-amount">50,000ì›</span>
            </div>
        </div>

        <div class="form-group">
            <label for="orderId">ì£¼ë¬¸ ID (í…ŒìŠ¤íŠ¸ìš©)</label>
            <input type="number" id="orderId" placeholder="ì£¼ë¬¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" value="1">
            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                ì‹¤ì œ ì „ì†¡ ì‹œ "ORDER_1_íƒ€ì„ìŠ¤íƒ¬í”„" í˜•ì‹ìœ¼ë¡œ ìë™ ë³€í™˜ë©ë‹ˆë‹¤
            </small>
        </div>

        <div class="form-group">
            <label for="orderName">ì£¼ë¬¸ëª…</label>
            <input type="text" id="orderName" placeholder="ì£¼ë¬¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" value="í…ŒìŠ¤íŠ¸ ìƒí’ˆ">
        </div>

        <div class="form-group">
            <label for="amount">ê²°ì œ ê¸ˆì•¡ (ì›)</label>
            <input type="number" id="amount" placeholder="ê²°ì œ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”" value="50000">
        </div>

        <div class="form-group">
            <label for="customerName">ì£¼ë¬¸ìëª…</label>
            <input type="text" id="customerName" placeholder="ì£¼ë¬¸ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”" value="í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì">
        </div>

        <button class="button" onclick="initializePayment()">ê²°ì œ ìœ„ì ¯ ë¶ˆëŸ¬ì˜¤ê¸°</button>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 10px; color: #666;">ê²°ì œ ìœ„ì ¯ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <!-- ê²°ì œ ìœ„ì ¯ì´ ë Œë”ë§ë  ì˜ì—­ -->
        <div id="payment-widget" style="display: none;"></div>

        <!-- ì•½ê´€ ë™ì˜ ì²´í¬ë°•ìŠ¤ -->
        <div id="agreement" style="display: none;"></div>

        <!-- ê²°ì œí•˜ê¸° ë²„íŠ¼ -->
        <button id="payment-button" class="button" style="display: none;">ê²°ì œí•˜ê¸°</button>
    </div>

    <!-- í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ ìœ„ì ¯ SDK ë¡œë“œ -->
    <script src="https://js.tosspayments.com/v1/payment-widget"></script>

    <!-- SDK ë¡œë“œ í™•ì¸ -->
    <script>
        console.log('SDK ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹œì‘');
        window.addEventListener('error', function(e) {
            if (e.target.tagName === 'SCRIPT') {
                console.error('ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', e.target.src);
                alert('í† ìŠ¤í˜ì´ë¨¼ì¸  SDK ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }, true);

        // SDK ë¡œë“œ ì™„ë£Œ í™•ì¸
        window.addEventListener('load', function() {
            console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            console.log('PaymentWidget ì¡´ì¬:', typeof PaymentWidget);
            console.log('loadTossPayments ì¡´ì¬:', typeof loadTossPayments);
        });
    </script>

    <script>
        // í† ìŠ¤í˜ì´ë¨¼ì¸  ì„¤ì • (ì„œë²„ì—ì„œ ê°€ì ¸ì˜´)
        let tossConfig = null;
        let sdkLoaded = false;

        // ê²°ì œìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤
        let paymentWidget;

        // SDK ë¡œë“œ ëŒ€ê¸°
        function waitForSDK() {
            return new Promise((resolve) => {
                // v1 PaymentWidget ë˜ëŠ” v2 loadTossPayments ì²´í¬
                if (typeof PaymentWidget !== 'undefined' || typeof loadTossPayments !== 'undefined') {
                    sdkLoaded = true;
                    console.log('SDK ë¡œë“œ í™•ì¸:', {
                        PaymentWidget: typeof PaymentWidget,
                        loadTossPayments: typeof loadTossPayments
                    });
                    resolve();
                    return;
                }
F
                const checkSDK = setInterval(() => {
                    if (typeof PaymentWidget !== 'undefined' || typeof loadTossPayments !== 'undefined') {
                        sdkLoaded = true;
                        console.log('SDK ë¡œë“œ í™•ì¸:', {
                            PaymentWidget: typeof PaymentWidget,
                            loadTossPayments: typeof loadTossPayments
                        });
                        clearInterval(checkSDK);
                        resolve();
                    }
                }, 100);

                // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
                setTimeout(() => {
                    clearInterval(checkSDK);
                    if (!sdkLoaded) {
                        console.error('SDK ë¡œë“œ íƒ€ì„ì•„ì›ƒ');
                        console.error('ì‚¬ìš© ê°€ëŠ¥í•œ ê°ì²´:', Object.keys(window).filter(k => k.toLowerCase().includes('toss') || k.toLowerCase().includes('payment')));
                        alert('í† ìŠ¤í˜ì´ë¨¼ì¸  SDKë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                    }
                }, 10000);
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í† ìŠ¤í˜ì´ë¨¼ì¸  ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        async function loadTossConfig() {
            try {
                const response = await fetch('/api/payments/toss/client-key');
                tossConfig = await response.json();
                console.log('í† ìŠ¤í˜ì´ë¨¼ì¸  ì„¤ì • ë¡œë“œ ì™„ë£Œ:', tossConfig);
            } catch (error) {
                console.error('í† ìŠ¤í˜ì´ë¨¼ì¸  ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('í† ìŠ¤í˜ì´ë¨¼ì¸  ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ì • ë° SDK ë¡œë“œ
        Promise.all([loadTossConfig(), waitForSDK()]).then(() => {
            console.log('ëª¨ë“  ì´ˆê¸°í™” ì™„ë£Œ');
        });

        // ê²°ì œ ìœ„ì ¯ ì´ˆê¸°í™”
        async function initializePayment() {
            // SDK ë¡œë“œ ëŒ€ê¸°
            if (!sdkLoaded) {
                console.log('SDK ë¡œë“œ ëŒ€ê¸° ì¤‘...');
                await waitForSDK();
            }

            // ì„¤ì • ë¡œë“œ í™•ì¸
            if (!tossConfig) {
                console.log('ì„¤ì • ë¡œë“œ ëŒ€ê¸° ì¤‘...');
                await loadTossConfig();
                if (!tossConfig) {
                    alert('í† ìŠ¤í˜ì´ë¨¼ì¸  ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
            }

            const orderIdInput = document.getElementById('orderId').value;
            const orderNameInput = document.getElementById('orderName').value;
            const amountInput = document.getElementById('amount').value;
            const customerNameInput = document.getElementById('customerName').value;

            if (!orderIdInput || !orderNameInput || !amountInput) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // í™”ë©´ ì—…ë°ì´íŠ¸
            document.getElementById('display-order-id').textContent = orderIdInput;
            document.getElementById('display-order-name').textContent = orderNameInput;
            document.getElementById('display-amount').textContent = Number(amountInput).toLocaleString() + 'ì›';

            // ë¡œë”© í‘œì‹œ
            document.getElementById('loading').style.display = 'block';

            try {
                console.log('í† ìŠ¤í˜ì´ë¨¼ì¸  SDK ì´ˆê¸°í™” ì¤‘...', tossConfig.clientKey);

                const customerKey = 'customer_' + Date.now();

                // v1 PaymentWidget ì‚¬ìš© (ê¶Œì¥)
                if (typeof PaymentWidget !== 'undefined') {
                    console.log('PaymentWidget v1 ì‚¬ìš©');

                    paymentWidget = await PaymentWidget(tossConfig.clientKey, customerKey);
                    console.log('PaymentWidget ì´ˆê¸°í™” ì™„ë£Œ');

                    // ê²°ì œ UI ë Œë”ë§ (ê¸ˆì•¡ í¬í•¨)
                    await paymentWidget.renderPaymentMethods(
                        '#payment-widget',
                        { value: Number(amountInput), currency: 'KRW' },
                        { variantKey: 'DEFAULT' }
                    );
                    console.log('ê²°ì œ ë©”ì„œë“œ ë Œë”ë§ ì™„ë£Œ');

                    // ì•½ê´€ UI ë Œë”ë§
                    await paymentWidget.renderAgreement(
                        '#agreement',
                        { variantKey: 'AGREEMENT' }
                    );
                    console.log('ì•½ê´€ ë Œë”ë§ ì™„ë£Œ');
                }
                // v2 loadTossPayments ì‚¬ìš© (ëŒ€ì²´)
                else if (typeof loadTossPayments !== 'undefined') {
                    console.log('loadTossPayments v2 ì‚¬ìš©');

                    const tossPayments = await loadTossPayments(tossConfig.clientKey);
                    console.log('loadTossPayments ì´ˆê¸°í™” ì™„ë£Œ');

                    // ê²°ì œìœ„ì ¯ ë Œë”ë§
                    paymentWidget = tossPayments.widgets({
                        customerKey: customerKey
                    });

                    // ê²°ì œ ê¸ˆì•¡ ì„¤ì •
                    await paymentWidget.setAmount({
                        currency: 'KRW',
                        value: Number(amountInput)
                    });

                    // ê²°ì œ UI ë Œë”ë§
                    await paymentWidget.renderPaymentMethods({
                        selector: '#payment-widget',
                        variantKey: 'DEFAULT'
                    });

                    // ì•½ê´€ UI ë Œë”ë§
                    await paymentWidget.renderAgreement({
                        selector: '#agreement',
                        variantKey: 'AGREEMENT'
                    });
                }
                else {
                    throw new Error('í† ìŠ¤í˜ì´ë¨¼ì¸  SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }

                // UI í‘œì‹œ
                document.getElementById('loading').style.display = 'none';
                document.getElementById('payment-widget').style.display = 'block';
                document.getElementById('agreement').style.display = 'block';
                document.getElementById('payment-button').style.display = 'block';

                // ê²°ì œí•˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
                document.getElementById('payment-button').onclick = async function() {
                    try {
                        // ë²„íŠ¼ í´ë¦­ ì‹œì ì— ìµœì‹  ê°’ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
                        const currentOrderId = document.getElementById('orderId').value;
                        const currentOrderName = document.getElementById('orderName').value;
                        const currentAmount = document.getElementById('amount').value;
                        const currentCustomerName = document.getElementById('customerName').value;

                        // ê°’ ê²€ì¦
                        if (!currentOrderId || !currentOrderName || !currentAmount) {
                            alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                            return;
                        }

                        // orderIdë¥¼ í† ìŠ¤í˜ì´ë¨¼ì¸  í˜•ì‹ì— ë§ê²Œ ìƒì„± (6-64ì, ì˜ë¬¸/ìˆ«ì/-/_ë§Œ í—ˆìš©)
                        const timestamp = Date.now();
                        // ì•ˆì „í•œ orderId ìƒì„± (ì˜ë¬¸, ìˆ«ì, -, _ë§Œ í—ˆìš©)
                        const safeOrderId = String(currentOrderId).replace(/[^a-zA-Z0-9_-]/g, '');
                        const formattedOrderId = `ORDER_${safeOrderId}_${timestamp}`;

                        console.log('ê²°ì œ ìš”ì²­ ë°ì´í„°:', {
                            ì›ë³¸OrderId: currentOrderId,
                            ì •ì œëœOrderId: safeOrderId,
                            ìµœì¢…OrderId: formattedOrderId,
                            orderName: currentOrderName,
                            amount: Number(currentAmount),
                            customerName: currentCustomerName,
                            ê¸¸ì´ì²´í¬: formattedOrderId.length,
                            í˜•ì‹ì²´í¬: /^[a-zA-Z0-9_-]+$/.test(formattedOrderId)
                        });

                        // ê²°ì œ ìš”ì²­
                        await paymentWidget.requestPayment({
                            orderId: formattedOrderId,
                            orderName: currentOrderName,
                            customerName: currentCustomerName,
                            successUrl: tossConfig.successUrl || (window.location.origin + '/payment-success.html'),
                            failUrl: tossConfig.failUrl || (window.location.origin + '/payment-fail.html')
                        });
                    } catch (error) {
                        console.error('ê²°ì œ ìš”ì²­ ì‹¤íŒ¨:', error);
                        console.error('ì—ëŸ¬ ìƒì„¸:', error);
                        alert('ê²°ì œ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    }
                };

                console.log('ê²°ì œ ìœ„ì ¯ ì´ˆê¸°í™” ì™„ë£Œ');

            } catch (error) {
                console.error('ê²°ì œ ìœ„ì ¯ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                alert('ê²°ì œ ìœ„ì ¯ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }
    </script>
</body>
</html>
