<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>토스페이먼츠 결제 위젯 테스트</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 4px;
        }

        .info-box h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-box p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .test-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .test-info h4 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .test-info ul {
            margin-left: 20px;
            color: #856404;
            font-size: 13px;
        }

        .test-info li {
            margin-bottom: 5px;
        }

        #payment-widget {
            margin: 30px 0;
        }

        #agreement {
            margin: 20px 0;
        }

        .button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .button:active {
            transform: translateY(0);
        }

        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .order-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .order-summary h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #666;
            font-size: 14px;
        }

        .order-total {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #dee2e6;
            font-weight: 600;
            font-size: 18px;
            color: #333;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>💳 토스페이먼츠 결제 테스트</h1>
        <p class="subtitle">결제 위젯 v2 연동 테스트 페이지</p>

        <div class="info-box">
            <h3>📌 테스트 환경 안내</h3>
            <p>
                현재 토스페이먼츠 테스트 모드로 동작합니다.<br>
                실제 결제는 발생하지 않으며, 전체 결제 플로우를 테스트할 수 있습니다.
            </p>
        </div>

        <div class="test-info">
            <h4>🔑 테스트 카드 정보</h4>
            <ul>
                <li>카드번호: 아무 숫자 16자리</li>
                <li>유효기간: 미래 날짜 (예: 12/25)</li>
                <li>CVC: 아무 숫자 3자리</li>
                <li>비밀번호: 아무 숫자 2자리</li>
            </ul>
        </div>

        <div class="order-summary">
            <h3>주문 정보</h3>
            <div class="order-item">
                <span>상품명</span>
                <span id="display-order-name">테스트 상품</span>
            </div>
            <div class="order-item">
                <span>주문 ID</span>
                <span id="display-order-id">-</span>
            </div>
            <div class="order-total">
                <span>결제 금액</span>
                <span id="display-amount">50,000원</span>
            </div>
        </div>

        <div class="form-group">
            <label for="orderId">주문 ID (테스트용)</label>
            <input type="number" id="orderId" placeholder="주문 ID를 입력하세요" value="1">
            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                실제 전송 시 "ORDER_1_타임스탬프" 형식으로 자동 변환됩니다
            </small>
        </div>

        <div class="form-group">
            <label for="orderName">주문명</label>
            <input type="text" id="orderName" placeholder="주문명을 입력하세요" value="테스트 상품">
        </div>

        <div class="form-group">
            <label for="amount">결제 금액 (원)</label>
            <input type="number" id="amount" placeholder="결제 금액을 입력하세요" value="50000">
        </div>

        <div class="form-group">
            <label for="customerName">주문자명</label>
            <input type="text" id="customerName" placeholder="주문자명을 입력하세요" value="테스트 사용자">
        </div>

        <button class="button" onclick="initializePayment()">결제 위젯 불러오기</button>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 10px; color: #666;">결제 위젯을 불러오는 중...</p>
        </div>

        <!-- 결제 위젯이 렌더링될 영역 -->
        <div id="payment-widget" style="display: none;"></div>

        <!-- 약관 동의 체크박스 -->
        <div id="agreement" style="display: none;"></div>

        <!-- 결제하기 버튼 -->
        <button id="payment-button" class="button" style="display: none;">결제하기</button>
    </div>

    <!-- 토스페이먼츠 결제 위젯 SDK 로드 -->
    <script src="https://js.tosspayments.com/v1/payment-widget"></script>

    <!-- SDK 로드 확인 -->
    <script>
        console.log('SDK 스크립트 로드 시작');
        window.addEventListener('error', function(e) {
            if (e.target.tagName === 'SCRIPT') {
                console.error('스크립트 로드 실패:', e.target.src);
                alert('토스페이먼츠 SDK 로드에 실패했습니다. 인터넷 연결을 확인해주세요.');
            }
        }, true);

        // SDK 로드 완료 확인
        window.addEventListener('load', function() {
            console.log('페이지 로드 완료');
            console.log('PaymentWidget 존재:', typeof PaymentWidget);
            console.log('loadTossPayments 존재:', typeof loadTossPayments);
        });
    </script>

    <script>
        // 토스페이먼츠 설정 (서버에서 가져옴)
        let tossConfig = null;
        let sdkLoaded = false;

        // 결제위젯 인스턴스
        let paymentWidget;

        // SDK 로드 대기
        function waitForSDK() {
            return new Promise((resolve) => {
                // v1 PaymentWidget 또는 v2 loadTossPayments 체크
                if (typeof PaymentWidget !== 'undefined' || typeof loadTossPayments !== 'undefined') {
                    sdkLoaded = true;
                    console.log('SDK 로드 확인:', {
                        PaymentWidget: typeof PaymentWidget,
                        loadTossPayments: typeof loadTossPayments
                    });
                    resolve();
                    return;
                }
F
                const checkSDK = setInterval(() => {
                    if (typeof PaymentWidget !== 'undefined' || typeof loadTossPayments !== 'undefined') {
                        sdkLoaded = true;
                        console.log('SDK 로드 확인:', {
                            PaymentWidget: typeof PaymentWidget,
                            loadTossPayments: typeof loadTossPayments
                        });
                        clearInterval(checkSDK);
                        resolve();
                    }
                }, 100);

                // 10초 타임아웃
                setTimeout(() => {
                    clearInterval(checkSDK);
                    if (!sdkLoaded) {
                        console.error('SDK 로드 타임아웃');
                        console.error('사용 가능한 객체:', Object.keys(window).filter(k => k.toLowerCase().includes('toss') || k.toLowerCase().includes('payment')));
                        alert('토스페이먼츠 SDK를 불러오는데 실패했습니다. 페이지를 새로고침해주세요.');
                    }
                }, 10000);
            });
        }

        // 페이지 로드 시 토스페이먼츠 설정 가져오기
        async function loadTossConfig() {
            try {
                const response = await fetch('/api/payments/toss/client-key');
                tossConfig = await response.json();
                console.log('토스페이먼츠 설정 로드 완료:', tossConfig);
            } catch (error) {
                console.error('토스페이먼츠 설정 로드 실패:', error);
                alert('토스페이먼츠 설정을 불러오는데 실패했습니다. 페이지를 새로고침해주세요.');
            }
        }

        // 페이지 로드 시 설정 및 SDK 로드
        Promise.all([loadTossConfig(), waitForSDK()]).then(() => {
            console.log('모든 초기화 완료');
        });

        // 결제 위젯 초기화
        async function initializePayment() {
            // SDK 로드 대기
            if (!sdkLoaded) {
                console.log('SDK 로드 대기 중...');
                await waitForSDK();
            }

            // 설정 로드 확인
            if (!tossConfig) {
                console.log('설정 로드 대기 중...');
                await loadTossConfig();
                if (!tossConfig) {
                    alert('토스페이먼츠 설정을 불러오지 못했습니다.');
                    return;
                }
            }

            const orderIdInput = document.getElementById('orderId').value;
            const orderNameInput = document.getElementById('orderName').value;
            const amountInput = document.getElementById('amount').value;
            const customerNameInput = document.getElementById('customerName').value;

            if (!orderIdInput || !orderNameInput || !amountInput) {
                alert('모든 필드를 입력해주세요.');
                return;
            }

            // 화면 업데이트
            document.getElementById('display-order-id').textContent = orderIdInput;
            document.getElementById('display-order-name').textContent = orderNameInput;
            document.getElementById('display-amount').textContent = Number(amountInput).toLocaleString() + '원';

            // 로딩 표시
            document.getElementById('loading').style.display = 'block';

            try {
                console.log('토스페이먼츠 SDK 초기화 중...', tossConfig.clientKey);

                const customerKey = 'customer_' + Date.now();

                // v1 PaymentWidget 사용 (권장)
                if (typeof PaymentWidget !== 'undefined') {
                    console.log('PaymentWidget v1 사용');

                    paymentWidget = await PaymentWidget(tossConfig.clientKey, customerKey);
                    console.log('PaymentWidget 초기화 완료');

                    // 결제 UI 렌더링 (금액 포함)
                    await paymentWidget.renderPaymentMethods(
                        '#payment-widget',
                        { value: Number(amountInput), currency: 'KRW' },
                        { variantKey: 'DEFAULT' }
                    );
                    console.log('결제 메서드 렌더링 완료');

                    // 약관 UI 렌더링
                    await paymentWidget.renderAgreement(
                        '#agreement',
                        { variantKey: 'AGREEMENT' }
                    );
                    console.log('약관 렌더링 완료');
                }
                // v2 loadTossPayments 사용 (대체)
                else if (typeof loadTossPayments !== 'undefined') {
                    console.log('loadTossPayments v2 사용');

                    const tossPayments = await loadTossPayments(tossConfig.clientKey);
                    console.log('loadTossPayments 초기화 완료');

                    // 결제위젯 렌더링
                    paymentWidget = tossPayments.widgets({
                        customerKey: customerKey
                    });

                    // 결제 금액 설정
                    await paymentWidget.setAmount({
                        currency: 'KRW',
                        value: Number(amountInput)
                    });

                    // 결제 UI 렌더링
                    await paymentWidget.renderPaymentMethods({
                        selector: '#payment-widget',
                        variantKey: 'DEFAULT'
                    });

                    // 약관 UI 렌더링
                    await paymentWidget.renderAgreement({
                        selector: '#agreement',
                        variantKey: 'AGREEMENT'
                    });
                }
                else {
                    throw new Error('토스페이먼츠 SDK가 로드되지 않았습니다.');
                }

                // UI 표시
                document.getElementById('loading').style.display = 'none';
                document.getElementById('payment-widget').style.display = 'block';
                document.getElementById('agreement').style.display = 'block';
                document.getElementById('payment-button').style.display = 'block';

                // 결제하기 버튼 이벤트
                document.getElementById('payment-button').onclick = async function() {
                    try {
                        // 버튼 클릭 시점에 최신 값 다시 가져오기
                        const currentOrderId = document.getElementById('orderId').value;
                        const currentOrderName = document.getElementById('orderName').value;
                        const currentAmount = document.getElementById('amount').value;
                        const currentCustomerName = document.getElementById('customerName').value;

                        // 값 검증
                        if (!currentOrderId || !currentOrderName || !currentAmount) {
                            alert('모든 필드를 입력해주세요.');
                            return;
                        }

                        // orderId를 토스페이먼츠 형식에 맞게 생성 (6-64자, 영문/숫자/-/_만 허용)
                        const timestamp = Date.now();
                        // 안전한 orderId 생성 (영문, 숫자, -, _만 허용)
                        const safeOrderId = String(currentOrderId).replace(/[^a-zA-Z0-9_-]/g, '');
                        const formattedOrderId = `ORDER_${safeOrderId}_${timestamp}`;

                        console.log('결제 요청 데이터:', {
                            원본OrderId: currentOrderId,
                            정제된OrderId: safeOrderId,
                            최종OrderId: formattedOrderId,
                            orderName: currentOrderName,
                            amount: Number(currentAmount),
                            customerName: currentCustomerName,
                            길이체크: formattedOrderId.length,
                            형식체크: /^[a-zA-Z0-9_-]+$/.test(formattedOrderId)
                        });

                        // 결제 요청
                        await paymentWidget.requestPayment({
                            orderId: formattedOrderId,
                            orderName: currentOrderName,
                            customerName: currentCustomerName,
                            successUrl: tossConfig.successUrl || (window.location.origin + '/payment-success.html'),
                            failUrl: tossConfig.failUrl || (window.location.origin + '/payment-fail.html')
                        });
                    } catch (error) {
                        console.error('결제 요청 실패:', error);
                        console.error('에러 상세:', error);
                        alert('결제 요청에 실패했습니다: ' + error.message);
                    }
                };

                console.log('결제 위젯 초기화 완료');

            } catch (error) {
                console.error('결제 위젯 초기화 실패:', error);
                alert('결제 위젯 초기화에 실패했습니다: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }
    </script>
</body>
</html>
